<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">

        <title>XPiratez Research Tree Explorer</title>
        <meta name="description" content="XPiratez Research Tree Explorer">
        <meta name="author" content="...">

        <!--[if lt IE 9]>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
        <![endif]-->

        <style>
         body {
             color: #d3d3d3;
             font: 12pt arial;
             background-color: #222222;
         }

         #graph {
             width: 1200px;
             height: 600px;
             border: 1px solid #444444;
             background-color: #222222;
         }
        </style>
    </head>
    <link rel="stylesheet" href="vis.min.css">
    <script type="text/javascript" src="cytoscape.min.js"></script>
    <script type="text/javascript" src="lodash.min.js"></script>
    <script type="text/javascript" src="jquery-3.2.1.min.js"></script>
    <body>
        <div>XPiratez Research Tree Explorer</div>
        <div id="graph"></div>
        <script type="text/javascript">
         var researchData = <%= researchData %>;
         var addedTopics = {};
         var dupeTopics = [];
         var elements = [];
         $(function() {
             _.each(researchData, function(topic, idx) {
                 if(addedTopics[topic.id]) {
                     dupeTopics.push(topic.id);
                     // we have to bail because this is a repeat
                     return true;
                 }
                 addedTopics[topic.id] = true;

                 // add node here
                 elements.push({
                     data: {
                         id: topic.id,
                         name: topic.label,
                         weight: idx,
                     },
                     classes: topic.needItem ? 'idea' : 'item',
                 });
             });

             // a second traversal to add edges; we can't do this until we
             // know what all of the topics are
             _.each(researchData, function(topic) {
                 if(topic.dependencies) {
                     _.each(topic.dependencies, function(dep) {
                         if(addedTopics[topic.id] && addedTopics[dep]) {
                             elements.push({
                                 data: {
                                     id: dep+"->"+topic.id,
                                     target: topic.id,
                                     source: dep
                                 },
                                 classes: 'dep'
                             });
                         }
                     });
                 }
                 if(topic.unlocks) {
                     _.each(topic.unlocks, function(dep) {
                         if(addedTopics[topic.id] && addedTopics[dep]) {
                             elements.push({
                                 data: {
                                     id: dep+"->"+topic.id,
                                     target: topic.id,
                                     source: dep
                                 },
                                 classes: 'unlocks'
                             });
                         }
                     });
                 }
                 if(topic.requires) {
                     _.each(topic.requires, function(dep) {
                         // these are events mostly
                         if(!addedTopics[dep]) {
                             elements.push({
                                 data: {
                                     id: dep,
                                     name: dep,
                                     weight: idx,
                                 },
                                 classes: event
                             });
                         }
                         elements.push({
                             data: {
                                 id: dep+"->"+topic.id,
                                 target: topic.id,
                                 source: dep
                             },
                             classes: 'requires'
                         });
                     });
                 }
                 if(topic.getOneFree) {
                     _.each(topic.getOneFree, function(dep) {
                         if(addedTopics[topic.id] && addedTopics[dep]) {
                             elements.push({
                                 data: {
                                     id: dep+"->"+topic.id,
                                     target: topic.id,
                                     source: dep
                                 },
                                 classes: 'getOneFree'
                             });
                         }
                     });
                 }
             });

             var cy = cytoscape({
                 container: document.getElementById('graph'),
                 elements: elements,

                 /*
                    layout: {
                    name: 'cose',
                    fit: false,
                    nodeDimensionsIncludeLabels: true,
                    },
                  */
                 layout: {
                     name: 'concentric',
                     concentric: function( ele ){ return ele.data('weight'); },
                     levelWidth: function( nodes ){ return nodes.length / 80; },
                     padding: 10,
                     fit: false,
                     avoidOverlap: true,
                     nodeDimensionsIncludeLabels: true
                 },
                 /*
                    layout: {
                    name: 'grid',
                    avoidOverlap: true,
                    avoidOverlapPadding: 100,
                    padding: 500,
                    fit: false,
                    //nodeDimensionsIncludeLabels: true
                    },
                  */
                 style: [
                     // edge styles
                     {"selector": ".dep",
                      "style": {
                          "width": "1px",
                          "line-color": "#1a1",
                          "target-arrow-shape": "triangle",
                          "target-arrow-color": "#1a1",
                      }},
                     {"selector": ".unlocks",
                      "style": {
                          "width": "1px",
                          "line-color": "#11a",
                          "target-arrow-shape": "triangle",
                          "target-arrow-color": "#11a",
                      }},
                     {"selector": ".requires",
                      "style": {
                          "width": "1px",
                          "line-color": "#aaa",
                          "target-arrow-shape": "triangle",
                          "target-arrow-color": "#aaa",
                      }},
                     {"selector": ".getOneFree",
                      "style": {
                          "width": "1px",
                          "line-color": "#a11",
                          "target-arrow-shape": "triangle",
                          "target-arrow-color": "#a11",
                      }},
                     // node styles
                     {"selector": "node.idea",
                      "style": {
                          "width": "mapData(score, 0, 0.006769776522008331, 20, 60)",
                          "height": "mapData(score, 0, 0.006769776522008331, 20, 60)",
                          "content": "data(name)",
                          "font-size": "9px",
                          "text-valign": "center",
                          "text-halign": "center",
                          "background-color": "green",
                          "text-outline-color": "#555",
                          "text-outline-width": "1px",
                          "color": "#fff",
                          "overlay-padding": "6px",
                          "z-index": "10",
                          shape: "rectangle"
                      }},
                     {"selector": "node.item",
                      "style": {
                          "width": "mapData(score, 0, 0.006769776522008331, 20, 60)",
                          "height": "mapData(score, 0, 0.006769776522008331, 20, 60)",
                          "content": "data(name)",
                          "font-size": "9px",
                          "text-valign": "center",
                          "text-halign": "center",
                          "background-color": "blue",
                          "text-outline-color": "#555",
                          "text-outline-width": "1px",
                          "color": "#fff",
                          "overlay-padding": "6px",
                          "z-index": "10",
                          shape: "ellipse"
                      }},
                     {"selector": "node.event",
                      "style": {
                          "width": "mapData(score, 0, 0.006769776522008331, 20, 60)",
                          "height": "mapData(score, 0, 0.006769776522008331, 20, 60)",
                          "content": "data(name)",
                          "font-size": "9px",
                          "text-valign": "center",
                          "text-halign": "center",
                          "background-color": "gray",
                          "text-outline-color": "#555",
                          "text-outline-width": "1px",
                          "color": "#fff",
                          "overlay-padding": "6px",
                          "z-index": "10",
                          shape: "pentagon"
                      }}
                 ]
             });

             console.log("dupes in research tree");
             console.log(dupeTopics);
         });
        </script>
    </body>
</html>
